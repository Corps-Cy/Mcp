# 需求文档：混合模式智能文档处理器

## 1. 简介

本项目旨在开发一个双模式、可扩展的 MCP 工具，用于从多种票据（增值税发票、收据、火车票、商场小票）的图像或 PDF 中提取结构化的关键字段数据。工具应提供一个默认的本地处理模式，并能通过配置无缝切换到更强大的阿里云智能文档服务。

## 2. 需求列表

### 2.1 核心工具接口

*   **用户故事:** 作为一个 MCP 客户端，我希望能调用一个统一的工具接口，传入票据文件，并获取结构化的 JSON 数据，以便进行后续的自动化处理。
*   **验收标准:**
    1.  **当** 客户端调用 `ExtractTicketData` 工具并提供一个包含有效文件（图片或PDF）的 `OcrInput` 对象时，
        **则** 系统应返回一个包含识别结果的 JSON 格式字符串。
    2.  **当** `OcrInput` 对象中既没有 `FilePath` 也没有 `FileContent` 时，
        **则** 系统应返回一个明确的参数错误信息。

### 2.2 默认模式：本地解析

*   **用户故事:** 作为一个希望快速体验功能的用户，我希望在不进行任何外部服务配置的情况下，就能获得基础的票据识别能力。
*   **验收标准:**
    1.  **当** 系统未检测到阿里云配置环境变量时，
        **则** 工具必须在“本地解析”模式下运行。
    2.  **当** 在本地解析模式下处理一个支持的票据类型时，
        **则** 系统应使用 Tesseract OCR 提取全文本，并通过关键词和正则表达式尽力解析出预定义的字段（如总金额、日期等）。
    3.  **当** 在本地解析模式下，返回的 JSON 中 `mode` 字段的值必须是 `LocalParser`。
    4.  **当** 在本地解析模式下无法识别出任何字段时，
        **则** 返回的 JSON 中 `fields` 数组应为空。

### 2.3 增强模式：阿里云服务

*   **用户故事:** 作为一个追求高准确率的开发者，我希望能通过配置 API 密钥，让工具自动切换到专业的云服务上，以获取更可靠的识别结果。
*   **验收标准:**
    1.  **当** 系统检测到 `ALIBABA_CLOUD_ACCESS_KEY_ID` 和 `ALIBABA_CLOUD_ACCESS_KEY_SECRET` 环境变量时，
        **则** 工具必须在“阿里云”模式下运行。
    2.  **当** 在阿里云模式下处理一个文件时，
        **则** 系统必须调用阿里云的文档识别 API，并将文件内容发送给云服务。
    3.  **当** 阿里云服务成功返回结构化数据时，
        **则** 系统应将返回的数据映射到我们统一的 JSON 结构中，包括字段名、值、置信度和边界框坐标。
    4.  **当** 在阿里云模式下，返回的 JSON 中 `mode` 字段的值必须是 `AlibabaCloud`。
    5.  **当** 阿里云的 API Key 无效或网络请求失败时，
        **则** 系统应返回一个明确的云服务连接或认证失败的错误信息。

### 2.4 结构化输出

*   **用户故事:** 作为一个调用者，我需要返回的数据是包含精确坐标的、格式统一的 JSON，以便我能轻松地在原图上高亮显示字段位置或进行数据校验。
*   **验收标准:**
    1.  **当** 工具成功识别出字段时，
        **则** 返回的 JSON 字符串必须符合设计文档中定义的结构。
    2.  **当** 在增强模式下，`fields` 数组中的每个对象都必须包含 `fieldName`, `value`, `confidence`, 和 `boundingBox` 四个键。
    3.  **当** 在默认模式下，`fields` 数组中的每个对象至少需要包含 `fieldName` 和 `value`。
